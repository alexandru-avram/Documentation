# 02. Control flow (a.k.a. "functional programming" constructs)

## IF / ELSIF / ELSE
```sql
IF amount > 1000 THEN
  discount := 0.1;
ELSIF amount > 200 THEN
  discount := 0.05;
ELSE
  discount := 0;
END IF;
```

## Searched CASE (statement form)
```sql
CASE
  WHEN status = 'new' THEN new_count := new_count + 1;
  WHEN status = 'done' THEN done_count := done_count + 1;
  ELSE RAISE NOTICE 'unknown status: %', status;
END CASE;
```

## LOOP + EXIT / CONTINUE
```sql
LOOP
  EXIT WHEN i > 10;
  i := i + 1;
  CONTINUE WHEN i % 2 = 0;  -- skip even
  PERFORM do_work(i);
END LOOP;
```

## WHILE
```sql
WHILE attempts < 3 AND NOT ok LOOP
  attempts := attempts + 1;
  ok := try_once();
END LOOP;
```

## Numeric FOR
```sql
FOR i IN 1..10 LOOP
  total := total + i;
END LOOP;

FOR i IN REVERSE 5..1 LOOP
  -- do something
END LOOP;
```

## FOR over query (implicit cursor)
```sql
FOR rec IN
  SELECT id, total FROM orders WHERE created_at >= current_date
LOOP
  PERFORM process_order(rec.id, rec.total);
END LOOP;
```

## FOREACH (arrays)
```sql
FOREACH elem IN ARRAY tag_ids LOOP
  PERFORM attach_tag(obj_id, elem);
END LOOP;
```

## Exceptions (brief)
```sql
BEGIN
  PERFORM risky();
EXCEPTION WHEN unique_violation THEN
  RAISE NOTICE 'duplicate ignored';
END;
```